<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Next Chapter | Trip Pairing</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<style>
:root { --blue:#0033A1; --white:#fff; --gray:#e8ebf1; --muted:#56607a; }
*{box-sizing:border-box}
body{margin:0;font-family:Segoe UI,Inter,Arial,sans-serif;background:var(--white);color:#222;}
.wrapper{max-width:760px;margin:40px auto;padding:24px}
.card{background:#fff;border:1px solid var(--gray);border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:28px}
h1{color:var(--blue);margin:0 0 6px}
h2{margin:6px 0 18px;color:#111}
p{color:#444;margin:0 0 16px}
label{display:block;margin:14px 0 6px;font-weight:600}
input,select{width:100%;padding:12px 14px;border:1px solid var(--gray);border-radius:10px;font-size:15px}
.btn{background:var(--blue);color:#fff;border:0;padding:12px 18px;border-radius:10px;font-weight:700;cursor:pointer}
.btn.secondary{background:#5b647a}
.btn:disabled{opacity:.55;cursor:not-allowed}
.hidden{display:none}
.center{text-align:center}
.thank{font-size:36px;font-weight:800;color:var(--blue)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.note{color:var(--muted);font-size:13px}
.err{color:#c02929;font-size:14px;margin-top:6px}
hr{border:0;border-top:1px solid var(--gray);margin:18px 0}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
th,td{border:1px solid var(--gray);padding:8px;text-align:left}
th{background:#f8f9fb;color:#333}

/* CSV button top-right (admins only) */
.csv-btn{
  position:fixed; top:12px; right:12px; z-index:9999;
  background:#0f1a33; color:#fff; border:0;
  padding:8px 10px; border-radius:999px; font-weight:700;
  font-size:12px; box-shadow:0 2px 8px rgba(0,0,0,.2);
}
.csv-btn.hidden{display:none}
</style>
</head>
<body>

<button id="downloadBtn" class="csv-btn hidden" title="Download CSV">CSV ⭳</button>

<div class="wrapper">

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h1>The Next Chapter</h1>
    <h2>Trip Pairing System</h2>
    <p class="note">Enter your work email and select your gender to continue.</p>
    <label for="emailInput">Work email</label>
    <input type="email" id="emailInput" placeholder="you@company.com" autocomplete="email">

    <label for="genderSelect">Gender</label>
    <select id="genderSelect">
      <option value="" selected disabled>Choose…</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
    </select>

    <div style="margin-top:14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button class="btn" id="loginBtn">Continue</button>
      <span id="loginMsg" class="err"></span>
    </div>
  </div>

  <!-- FORM -->
  <div id="formCard" class="card hidden">
    <h1>The Next Chapter</h1>
    <h2>Trip Pairing System</h2>
    <p class="note">This site provides options for selecting the team member you wish to pair with at the off-site session. Kindly ensure you have agreed with your partner.</p>

    <div class="row">
      <div>
        <label for="yourName">Your name</label>
        <select id="yourName"></select>
      </div>
      <div>
        <label for="pairName">Your roommate</label>
        <select id="pairName"></select>
      </div>
    </div>

    <div style="margin-top:18px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button class="btn" id="doneBtn">Done</button>
      <span id="status" class="err"></span>
    </div>

    <hr>

    <details>
      <summary class="note">Admin (local only)</summary>
      <div style="margin-top:10px">
        <button class="btn secondary" id="resetLocal">Reset local used names</button>
        <button class="btn secondary" id="showData">Show local records</button>
        <div id="tableWrap"></div>
        <p class="note">Note: This page stores only in your browser unless you enable the optional global mode below.</p>
      </div>
    </details>
  </div>

  <!-- THANK YOU -->
  <div id="thankCard" class="card hidden center">
    <div class="thank">THANK YOU</div>
    <p class="note">Your pairing has been recorded.</p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
/* ===================== EASY-EDIT SECTION ===================== */
/* Paste your emails and names here. Keep quotes & commas.      */

/** Allow-list (non-admin users must be here) **/
const EMAIL_ALLOWLIST = ["wujangia@stanbic.com.gh","adamsc@STANBIC.COM.GH","dordziec@stanbic.com.gh","dapaahc@STANBIC.COM.GH","daflisog@stanbic.com.gh","adu-gyamfib@STANBIC.COM.GH","agbekop@STANBIC.COM.GH","adudl@stanbic.com.gh","tettehr@STANBIC.COM.GH","aidoo-quarcoopomed@STANBIC.COM.GH","kutin-boatengsnra@STANBIC.COM.GH","adukpov@STANBIC.COM.GH","boisonc@STANBIC.COM.GH","michaelt@STANBIC.COM.GH","asimenua@STANBIC.COM.GH","gyamfi-bediakom@STANBIC.COM.GH","puopilam@STANBIC.COM.GH","newmanw@STANBIC.COM.GH","aryeeteyr@STANBIC.COM.GH","sumbop@STANBIC.COM.GH","dadsonn@STANBIC.COM.GH","inusahs@STANBIC.COM.GH","njorgnaby@STANBIC.COM.GH","wellingtonk@STANBIC.COM.GH","harrisona@STANBIC.COM.GH","alhassane@STANBIC.COM.GH","dakurahe@STANBIC.COM.GH","okines@STANBIC.COM.GH","fouillardm@STANBIC.COM.GH","pobi@stanbic.com.gh","hardingr@STANBIC.COM.GH","atsunyog@STANBIC.COM.GH","dawform@STANBIC.COM.GH","osahk@STANBIC.COM.GH","koduad@STANBIC.COM.GH","aggora@stanbic.com.gh","osei-frimpongb@STANBIC.COM.GH","quashiee@STANBIC.COM.GH","okyereg@STANBIC.COM.GH","kweku-duahb@STANBIC.COM.GH","zengc@stanbic.com.gh","manua@STANBIC.COM.GH","owusu-adjeio@STANBIC.COM.GH","onias@STANBIC.COM.GH","offeip@STANBIC.COM.GH","mohammeda@STANBIC.COM.GH","bosomtwes@STANBIC.COM.GH","ziblims@STANBIC.COM.GH","tsirim@STANBIC.COM.GH","kambiref@STANBIC.COM.GH","mcestod-dotsec@STANBIC.COM.GH","tetteyf@STANBIC.COM.GH","bimpehk@STANBIC.COM.GH","asarep@STANBIC.COM.GH","nasirdeenn@STANBIC.COM.GH","hassanf@STANBIC.COM.GH","agyemangj2@STANBIC.COM.GH","agyei-owusui@STANBIC.COM.GH","kpenem@STANBIC.COM.GH","amponsaha@STANBIC.COM.GH","jaiseyj@STANBIC.COM.GH","kyeremehr@STANBIC.COM.GH","amoquandoh-ocranr@STANBIC.COM.GH","addos@STANBIC.COM.GH","boatengka@STANBIC.COM.GH","takyie@STANBIC.COM.GH","aduamas@STANBIC.COM.GH","dorworshiem@STANBIC.COM.GH","quarshiem@STANBIC.COM.GH","ackumeyp@STANBIC.COM.GH","addo-quayee@STANBIC.COM.GH","borteyborketeye@STANBIC.COM.GH","kassimy@STANBIC.COM.GH","adjeisa@STANBIC.COM.GH","dzikunup@STANBIC.COM.GH","nyarkose@STANBIC.COM.GH","aak-ibrahimq@STANBIC.COM.GH","ampahg@STANBIC.COM.GH","austinc@STANBIC.COM.GH","osahe@STANBIC.COM.GH","mutawakila@STANBIC.COM.GH","acheampongp@STANBIC.COM.GH","boatengba@STANBIC.COM.GH","esselp@STANBIC.COM.GH","gharteyn@STANBIC.COM.GH","apenahierw@STANBIC.COM.GH","fuseiniw@STANBIC.COM.GH","laryeaca@STANBIC.COM.GH","dan-braimahp@STANBIC.COM.GH","yahayays@STANBIC.COM.GH","musaha2@STANBIC.COM.GH","TorgborK@stanbic.com.gh","ayikud@STANBIC.COM.GH","ako-nair@STANBIC.COM.GH","achampongf@STANBIC.COM.GH","adjepongg@STANBIC.COM.GH","alhassanu@STANBIC.COM.GH","abbanf@STANBIC.COM.GH","adjeteys@STANBIC.COM.GH","achamponge@STANBIC.COM.GH","amoyawp@STANBIC.COM.GH","oduro-ayisil@STANBIC.COM.GH","saeed-adamss@stanbic.com.gh","marteik@STANBIC.COM.GH","amponsahk@STANBIC.COM.GH","ibrahima2@STANBIC.COM.GH","nketian@STANBIC.COM.GH","boakyev@STANBIC.COM.GH","odonkore@STANBIC.COM.GH","yiadomn@STANBIC.COM.GH","owusur2@STANBIC.COM.GH","ziblimo@STANBIC.COM.GH","shalman-adoom@STANBIC.COM.GH","dentehe@STANBIC.COM.GH","afenyaf@STANBIC.COM.GH","brobbeyt@STANBIC.COM.GH","armahp2@STANBIC.COM.GH","asares@STANBIC.COM.GH","asamoahb3@STANBIC.COM.GH","konaduc2@STANBIC.COM.GH","adonur2@STANBIC.COM.GH","akweteyk@STANBIC.COM.GH","okinel@STANBIC.COM.GH","fomadzii@STANBIC.COM.GH","mohammeda5@STANBIC.COM.GH","annorr@STANBIC.COM.GH","mensahl3@STANBIC.COM.GH","ibrahimk@STANBIC.COM.GH","oseimensahm@STANBIC.COM.GH","cudjoei@STANBIC.COM.GH","buafulb@STANBIC.COM.GH","alhajiadamf@STANBIC.COM.GH","oppongl@STANBIC.COM.GH","baakoe2@STANBIC.COM.GH","agbovij@stanbic.com.gh","amegbep@stanbic.com.gh","ametepes@stanbic.com.gh","amissahm@stanbic.com.gh","cobbinaj@stanbic.com.gh","obengj@stanbic.com.gh","mensahg3@stanbic.com.gh","adi-blaya@stanbic.com.gh","BogobiriA@stanbic.com.gh","kudzinyap@stanbic.com.gh","LampteySD@stanbic.com.gh","puotierea@stanbic.com.gh","quaynors@stanbic.com.gh","asareg@stanbic.com.gh","appiahm@stanbic.com.gh","abdulaia2@stanbic.com.gh","djokotoj@stanbic.com.gh","baffoey@stanbic.com.gh","spioa@stanbic.com.gh","mohammedamins@stanbic.com.gh","OforiS@stanbic.com.gh","Ben-HabibC@stanbic.com.gh","Owusu-AnsahH@stanbic.com.gh","BoffahM@stanbic.com.gh","AminuN2@stanbic.com.gh","KadinchinaS2@stanbic.com.gh","FatawuY@stanbic.com.gh","aboagyes@stanbic.com.gh"];

/** Admins (always allowed to log in; always see CSV) **/
const ADMIN_EMAILS = ["torgbork@stanbic.com.gh","goodmann@stanbic.com.gh"];

/** People list with gender (additions included: Noora Ari Goodman, Doreen Danso) **/
const PEOPLE = [
  {name:"Ama Wujangi",sex:"Female"},
  {name:"Casandra Dapaah",sex:"Female"},
  {name:"Rebecca Obieley Eghan",sex:"Female"},
  {name:"Veronica Mawuena Aku Adukpo",sex:"Female"},
  {name:"Christabel Aba Bondzewah Boison",sex:"Female"},
  {name:"Annie Asimenu",sex:"Female"},
  {name:"Mavis Gyamfi-Bediako",sex:"Female"},
  {name:"Agnes Ivy Bimpeh Harrison",sex:"Female"},
  {name:"Euphemia Taale Dakurah",sex:"Female"},
  {name:"Maud Kukua Ofori-Dadzie",sex:"Female"},
  {name:"Rita Harding",sex:"Female"},
  {name:"Aboagyewaa Osei-Frimpong",sex:"Female"},
  {name:"Beatrice Dewi Kweku-Duah",sex:"Female"},
  {name:"Catherine Zeng",sex:"Female"},
  {name:"Nana Offeibea Owusu-Adjei",sex:"Female"},
  {name:"Sarah Bosomtwe",sex:"Female"},
  {name:"Sandalia Betintiche Ziblim",sex:"Female"},
  {name:"Portia Achiaa Asare",sex:"Female"},
  {name:"Nazirat Nasirdeen",sex:"Female"},
  {name:"Mawusuorm Mamle Kpene",sex:"Female"},
  {name:"Adobea Amponsah Nsakie",sex:"Female"},
  {name:"Rosemond Owiredu",sex:"Female"},
  {name:"Prudence Ami Ackumey",sex:"Female"},
  {name:"Sandra Ashirley Adjei",sex:"Female"},
  {name:"Perkina Selasie Dzikunu",sex:"Female"},
  {name:"Queen Xorla Aak-Ibrahim",sex:"Female"},
  {name:"Catherine Mary Austin",sex:"Female"},
  {name:"Evelyn Korkor lawerteh",sex:"Female"},
  {name:"Bridget Boateng",sex:"Female"},
  {name:"Priscilla Cynthia Essel",sex:"Female"},
  {name:"Nora Irene Ghartey",sex:"Female"},
  {name:"Winnie Nuerki Apenahier",sex:"Female"},
  {name:"Portia Ajuiley Dan-Braimah",sex:"Female"},
  {name:"Gifty Adjepong",sex:"Female"},
  {name:"Umme-Salma Alhassan",sex:"Female"},
  {name:"Esther Achampong",sex:"Female"},
  {name:"Loretta Oduro-Ayisi",sex:"Female"},
  {name:"Salimatu Saeed-Adams",sex:"Female"},
  {name:"Aruba Ibrahim",sex:"Female"},
  {name:"Rosemond Achiaa Owusu",sex:"Female"},
  {name:"Mary Yayra Shalman-Adoo",sex:"Female"},
  {name:"Theresah Serwaa Brobbey",sex:"Female"},
  {name:"Bridgette Asamoah",sex:"Female"},
  {name:"Linda Naa Korkoi Okine",sex:"Female"},
  {name:"Rosemary Twumwaa Annor",sex:"Female"},
  {name:"Leticia Mensah",sex:"Female"},
  {name:"Kubura Adizatu Khadija Ibrahim",sex:"Female"},
  {name:"Bertha Buaful",sex:"Female"},
  {name:"Fatimata Adam",sex:"Female"},
  {name:"Loretta Oppong",sex:"Female"},
  {name:"Eudel Nako Baako",sex:"Female"},
  {name:"Dedei-Agbovi Juliana",sex:"Female"},
  {name:"Ametepe Salomey",sex:"Female"},
  {name:"Amissah Mabel",sex:"Female"},
  {name:"Cobbina Jacqueline",sex:"Female"},
  {name:"Obeng Juliet",sex:"Female"},
  {name:"Mensah Geraldine",sex:"Female"},
  {name:"Adi-Blay Shilaynn Adobea",sex:"Female"},
  {name:"Kudzinya Paula Selorm",sex:"Female"},
  {name:"Lamptey Sheila Dansoa",sex:"Female"},
  {name:"Puotiere Angela Batiere",sex:"Female"},
  {name:"MohammedAmin Su-ad",sex:"Female"},
  {name:"Ofori Sarah",sex:"Female"},
  {name:"Ben-Habib Claudia",sex:"Female"},
  {name:"Aminu Nimatu",sex:"Female"},
  {name:"Kadinchina Sandra",sex:"Female"},
  {name:"Noora Ari Goodman",sex:"Female"},
  {name:"Doreen Danso",sex:"Female"},

  {name:"Charles Kofi Adams",sex:"Male"},
  {name:"Christian Dordzie",sex:"Male"},
  {name:"Geoffrey Dafliso",sex:"Male"},
  {name:"Bernard Opoku Adu-Gyamfi",sex:"Male"},
  {name:"Peter Agbeko",sex:"Male"},
  {name:"Daniel Adu",sex:"Male"},
  {name:"Dominic Aidoo-Quarcoopome",sex:"Male"},
  {name:"Atta Snr. Kutin-Boateng",sex:"Male"},
  {name:"Tony Michael",sex:"Male"},
  {name:"Michael Diattah Puopila",sex:"Male"},
  {name:"William Newman",sex:"Male"},
  {name:"Richard Aryeetey",sex:"Male"},
  {name:"Philemon Sumbo",sex:"Male"},
  {name:"Nana Kow Bediako Dadson",sex:"Male"},
  {name:"Sadik Inusah",sex:"Male"},
  {name:"Yaw Njorgnab",sex:"Male"},
  {name:"Kelvin Odartey Wellington",sex:"Male"},
  {name:"Eliasu Alhassan",sex:"Male"},
  {name:"Stephen Okine",sex:"Male"},
  {name:"Richard Pobi",sex:"Male"},
  {name:"Gordon Atsunyo",sex:"Male"},
  {name:"Michael Dawfor",sex:"Male"},
  {name:"Kartey Osah",sex:"Male"},
  {name:"Daniel Afriyie Kodua",sex:"Male"},
  {name:"Kofi Anani Aggor",sex:"Male"},
  {name:"Emmanuel Quashie",sex:"Male"},
  {name:"George Frimpong Okyere",sex:"Male"},
  {name:"Augustine Manu",sex:"Male"},
  {name:"Simon Onia",sex:"Male"},
  {name:"William Offei Parry",sex:"Male"},
  {name:"Abdul-Kadiri Mohammed",sex:"Male"},
  {name:"Michael Leslie Tsiri",sex:"Male"},
  {name:"Fernand Philippe Kambire Sey",sex:"Male"},
  {name:"Calvin Femi McEstod-Dotse",sex:"Male"},
  {name:"Felix Tettey",sex:"Male"},
  {name:"Kofi Owusu Achiaw Bimpeh",sex:"Male"},
  {name:"Fawzan Bamba Hassan",sex:"Male"},
  {name:"Joseph Ofori Agyemang",sex:"Male"},
  {name:"Isaac Agyei-Owusu",sex:"Male"},
  {name:"John Korku Jaisey",sex:"Male"},
  {name:"Richmond Amoquandoh-Ocran",sex:"Male"},
  {name:"Samuel Kojo Addo",sex:"Male"},
  {name:"Kwame Agyenim Boateng",sex:"Male"},
  {name:"Emmanuel Berko Takyi",sex:"Male"},
  {name:"Samuel-David Aduama",sex:"Male"},
  {name:"Daniel Mawuli Dorworshie",sex:"Male"},
  {name:"Maxwell Biney Quarshie",sex:"Male"},
  {name:"Ellis Aryeequaye Aggaine Addo-Quaye",sex:"Male"},
  {name:"Emmanuel Bortey BORKETEY",sex:"Male"},
  {name:"Yussif Kassim",sex:"Male"},
  {name:"Stephen Essuah Nyarko",sex:"Male"},
  {name:"George Ampah",sex:"Male"},
  {name:"Ahmed Iddrisu Mutawakil",sex:"Male"},
  {name:"Prince Yeboah Acheampong",sex:"Male"},
  {name:"Abdul-Basit Wunpini Fuseini",sex:"Male"},
  {name:"Christopher Adjei Laryea",sex:"Male"},
  {name:"Yakubu Sheini Yahaya",sex:"Male"},
  {name:"Abdul-Halik Naporow Musah",sex:"Male"},
  {name:"Kunim Akwetey Torgbor",sex:"Male"},
  {name:"Derek Amarquaye Ayiku",sex:"Male"},
  {name:"Thomas Romeo Ako-Nai",sex:"Male"},
  {name:"Fred Konadu Achampong",sex:"Male"},
  {name:"Frank Kwesi Abban",sex:"Male"},
  {name:"Samuel Ala Adjetey",sex:"Male"},
  {name:"Pierre Barrad Amoyaw",sex:"Male"},
  {name:"Kelvin Nii Martey Martei",sex:"Male"},
  {name:"Robert Amponsah",sex:"Male"},
  {name:"Nana Yaw Nketia",sex:"Male"},
  {name:"Emmanuel Boakye",sex:"Male"},
  {name:"Jacob Odonkor",sex:"Male"},
  {name:"Nana Asamoah Yiadom",sex:"Male"},
  {name:"Osman Ziblim",sex:"Male"},
  {name:"Eric Denteh",sex:"Male"},
  {name:"Francis Junior Afenya",sex:"Male"},
  {name:"Prince Quaye Armah",sex:"Male"},
  {name:"Samuel Asare",sex:"Male"},
  {name:"Charles Adu Konadu",sex:"Male"},
  {name:"Richmond Adonu",sex:"Male"},
  {name:"Kelvin Akwetey",sex:"Male"},
  {name:"Israel Eli Fomadzi",sex:"Male"},
  {name:"Abdul-Fatawu Mohammed",sex:"Male"},
  {name:"Michael Osei Mensah",sex:"Male"},
  {name:"Isaac Cudjoe",sex:"Male"},
  {name:"Amegbe Philip",sex:"Male"},
  {name:"Bogobiri Adiza Mohammed",sex:"Male"},
  {name:"Quaynor Samuel William",sex:"Male"},
  {name:"Asare George Otibu",sex:"Male"},
  {name:"Appiah  Adam Muzaffar",sex:"Male"},
  {name:"Abdulai Abdul-Manan",sex:"Male"},
  {name:"Djokoto Jesse",sex:"Male"},
  {name:"BAFFOE Yaw",sex:"Male"},
  {name:"Spio Anthony Prince",sex:"Male"},
  {name:"Owusu-Ansah Huldah",sex:"Male"},
  {name:"Adu Boffah Michael",sex:"Male"},
  {name:"Yakubu  Abdul Fatawu",sex:"Male"},
  {name:"Aboagye Stephen",sex:"Male"}
];

/* =================== END EASY-EDIT SECTION =================== */

/* ===== Optional: GLOBAL mode (locks names across all users/devices) =====
   1) Set USE_REMOTE = true
   2) Deploy the Google Apps Script in the comment at the bottom
   3) Paste its Web App URL into REMOTE_URL
*/
const USE_REMOTE = false;
const REMOTE_URL = "https://SCRIPT_WEB_APP_URL_HERE"; // only used if USE_REMOTE=true
/* ======================================================================= */

const loginCard = document.getElementById("loginCard");
const formCard  = document.getElementById("formCard");
const thankCard = document.getElementById("thankCard");
const emailInput= document.getElementById("emailInput");
const genderSel = document.getElementById("genderSelect");
const loginBtn  = document.getElementById("loginBtn");
const loginMsg  = document.getElementById("loginMsg");
const yourSel   = document.getElementById("yourName");
const pairSel   = document.getElementById("pairName");
const doneBtn   = document.getElementById("doneBtn");
const downloadBtn=document.getElementById("downloadBtn");
const statusEl  = document.getElementById("status");
const tableWrap = document.getElementById("tableWrap");
const resetLocal= document.getElementById("resetLocal");
const showData  = document.getElementById("showData");

let yourChoices, pairChoices;
let currentEmail = "";
let currentGender = ""; // NEW: chosen gender

/* Local persistence (per device) */
const USED_KEY = "pairing_used_names_v4";
const RECS_KEY = "pairing_records_v4";
let usedNames = new Set(JSON.parse(localStorage.getItem(USED_KEY) || "[]"));
let records   = JSON.parse(localStorage.getItem(RECS_KEY) || "[]");

function saveLocal(){
  localStorage.setItem(USED_KEY, JSON.stringify([...usedNames]));
  localStorage.setItem(RECS_KEY, JSON.stringify(records));
}

/* Helpers to get names by gender */
function namesByGender(g){
  return PEOPLE.filter(p => p.sex === g).map(p => p.name);
}

/* ---------- Remote helpers (optional global mode) ---------- */
async function remoteGetState(){
  if(!USE_REMOTE) return { used:[...usedNames], rows:records };
  const r = await fetch(REMOTE_URL+'?mode=get', {cache:'no-store'});
  if(!r.ok) throw new Error('Remote get failed');
  return await r.json();
}
async function remoteSubmit(row){
  if(!USE_REMOTE) return { ok:true };
  const r = await fetch(REMOTE_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ mode:'submit', row })
  });
  if(!r.ok) throw new Error('Remote submit failed');
  return await r.json();
}

/* ---------- Choices init + refresh with selection preserved ---------- */
function initDropdowns(){
  yourChoices = new Choices(yourSel,{ searchEnabled:true, placeholder:true, shouldSort:true, searchPlaceholderValue:"Type to search…" });
  pairChoices = new Choices(pairSel,{ searchEnabled:true, placeholder:true, shouldSort:true, searchPlaceholderValue:"Type to search…" });
  refreshDropdowns(true);
}

function refreshDropdowns(preserve=false){
  const meValue = yourChoices ? yourChoices.getValue(true) : "";
  const partnerValue = pairChoices ? pairChoices.getValue(true) : "";

  const pool = namesByGender(currentGender);
  const available = pool.filter(n => !usedNames.has(n));

  // Rebuild "Your name"
  yourChoices.clearChoices();
  yourChoices.setChoices( available.map(n=>({value:n,label:n})), 'value','label', false );
  if(preserve && meValue && available.includes(meValue)) {
    yourChoices.setChoiceByValue(meValue);
  }

  // Rebuild "Partner" (exclude self)
  const partnerAvail = available.filter(n => n !== (meValue || ''));
  pairChoices.clearChoices();
  pairChoices.setChoices( partnerAvail.map(n=>({value:n,label:n})), 'value','label', false );
  if(preserve && partnerValue && partnerAvail.includes(partnerValue)) {
    pairChoices.setChoiceByValue(partnerValue);
  }
}

/* ---------- Login (case-insensitive; admins always allowed) ---------- */
loginBtn.onclick = async () => {
  const email = (emailInput.value || "").trim().toLowerCase();
  currentGender = genderSel.value || "";
  const allow = EMAIL_ALLOWLIST.map(e => (e||"").toLowerCase());
  const isAdmin = ADMIN_EMAILS.map(e => e.toLowerCase()).includes(email);

  if(!currentGender){
    loginMsg.textContent = "Please select your gender.";
    return;
  }
  if(!allow.includes(email) && !isAdmin){
    loginMsg.textContent = "Email not recognized.";
    return;
  }

  // Optional: load remote state (global) on login
  let state = { used:[...usedNames], rows:[...records] };
  try{
    state = await remoteGetState();
    if(USE_REMOTE){
      usedNames = new Set(state.used || []);
      records   = state.rows || [];
    }
  }catch(e){
    console.warn(e);
  }

  const hasSubmitted = (state.rows || []).some(r => (r.email||"").toLowerCase() === email);

  loginMsg.textContent = "";
  loginCard.classList.add("hidden");

  // Admins can always log in to view CSV; they can submit once only.
  if (isAdmin) {
    formCard.classList.remove("hidden");
    downloadBtn.classList.remove("hidden"); // show CSV top-right
    currentEmail = email;
    initDropdowns();
    if (hasSubmitted) {
      doneBtn.disabled = true;
      statusEl.textContent = "Admin: you have already submitted. CSV button is at the top-right.";
    } else {
      doneBtn.disabled = false;
      statusEl.textContent = "";
    }
    yourSel.addEventListener('change', () => refreshDropdowns(true));
    return;
  }

  // Non-admins: if already submitted, show Thank You only
  if (hasSubmitted || records.some(r => (r.email||"").toLowerCase() === email)) {
    thankCard.classList.remove("hidden");
    return;
  }

  // Otherwise, show form to submit
  formCard.classList.remove("hidden");
  currentEmail = email;
  initDropdowns();
  yourSel.addEventListener('change', () => refreshDropdowns(true));
};

/* ---------- Submit ---------- */
doneBtn.onclick = async () => {
  statusEl.textContent = "";
  const name = yourChoices.getValue(true);
  const partner = pairChoices.getValue(true);

  if(!name || !partner){
    statusEl.textContent = "Please select both names.";
    return;
  }
  if(name === partner){
    statusEl.textContent = "You cannot select the same person for both fields.";
    return;
  }

  // Verify against latest (remote if enabled)
  try{
    if(USE_REMOTE){
      const state = await remoteGetState();
      const latestUsed = new Set(state.used||[]);
      if(latestUsed.has(name) || latestUsed.has(partner)){
        statusEl.textContent = "One of the names has just been taken. Please choose again.";
        usedNames = latestUsed;
        refreshDropdowns(true);
        return;
      }
    }
  }catch(e){ console.warn(e); }

  const row = { email: currentEmail, name, partner, time: new Date().toISOString(), gender: currentGender };

  // Local update
  usedNames.add(name); usedNames.add(partner);
  records.push(row);
  saveLocal();

  // Optional global update
  try{ await remoteSubmit(row); }catch(e){ console.warn(e); }

  refreshDropdowns(true);
  formCard.classList.add("hidden");
  thankCard.classList.remove("hidden");
};

/* ---------- CSV (admins only; top-right button) ---------- */
downloadBtn.onclick = () => {
  if(records.length === 0){ alert("No records yet (local)."); return; }
  let out = "email,name,partner,gender,time\n";
  for(const r of records){
    const row = [r.email||"", r.name||"", r.partner||"", r.gender||"", r.time||""]
      .map(v => `"${String(v).replace(/"/g,'""')}"`).join(",");
    out += row + "\n";
  }
  const blob = new Blob([out], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "pairings.csv"; a.click();
  URL.revokeObjectURL(url);
};

/* ---------- Local admin helpers (on this device only) ---------- */
document.getElementById("resetLocal").onclick = () => {
  if(!confirm("This clears local used names & records on THIS device only. Continue?")) return;
  usedNames = new Set();
  records = [];
  saveLocal();
  refreshDropdowns(true);
  document.getElementById("tableWrap").innerHTML = "";
  alert("Local data cleared.");
};
document.getElementById("showData").onclick = () => {
  const tableWrap = document.getElementById("tableWrap");
  if(records.length === 0){ tableWrap.innerHTML = "<p class='note'>No local records yet.</p>"; return; }
  const rows = records.map(r => `<tr><td>${r.email||""}</td><td>${r.name||""}</td><td>${r.partner||""}</td><td>${r.gender||""}</td><td>${r.time||""}</td></tr>`).join("");
  tableWrap.innerHTML = `<table><thead><tr><th>Email</th><th>Name</th><th>Partner</th><th>Gender</th><th>Time</th></tr></thead><tbody>${rows}</tbody></table>`;
};
</script>

<!-- ================= OPTIONAL: Google Apps Script backend =================
If you want names to disappear for EVERYONE (global), do this quick setup:

1) Go to https://script.google.com  → New project.
2) Paste this code and save:

function doGet(e){
  const ss = getSheet_();
  const data = ss.getDataRange().getValues(); // header: email,name,partner,gender,time
  const used = new Set();
  const rows = [];
  for (let i=1;i<data.length;i++){
    const [email,name,partner,gender,time] = data[i];
    if(name) used.add(name);
    if(partner) used.add(partner);
    rows.push({email,name,partner,gender,time});
  }
  return ContentService.createTextOutput(JSON.stringify({used:[...used], rows}))
    .setMimeType(ContentService.MimeType.JSON);
}
function doPost(e){
  const body = JSON.parse(e.postData.contents||"{}");
  if(body.mode!=="submit") return doGet(e);
  const r = body.row||{};
  const ss = getSheet_();
  ss.appendRow([r.email||"", r.name||"", r.partner||"", r.gender||"", r.time||""]);
  return ContentService.createTextOutput(JSON.stringify({ok:true}))
    .setMimeType(ContentService.MimeType.JSON);
}
function getSheet_(){
  const id = PropertiesService.getScriptProperties().getProperty("SHEET_ID");
  const ss = SpreadsheetApp.openById(id);
  const sh = ss.getSheetByName("pairs") || ss.insertSheet("pairs");
  if (sh.getLastRow() === 0) sh.appendRow(["email","name","partner","gender","time"]);
  return sh;
}

3) Create a Google Sheet in Drive; copy its ID from the URL.
4) In Script editor: Project Settings → Script properties → Add SHEET_ID = your sheet ID.
5) Deploy → New deployment → Type: Web app → Execute as: Me → Who has access: Anyone with the link → Deploy.
6) Copy the Web App URL and paste it into REMOTE_URL above, then set USE_REMOTE = true.
=========================================================================== -->
</body>
</html>
